<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jolly Snowfall | Festive Wonderland</title>
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --evergreen: #0e2c1f;
      --evergreen-light: #174a33;
      --cranberry: #c22028;
      --cranberry-glow: #ff475d;
      --frost: #e8f7ff;
      --gold: #f4d35e;
      --midnight: #060c1a;
      --snow-soft: #f7fbff;
      --accent: #7fd1ff;
      --card-bg: rgba(11, 30, 23, 0.65);
      --glass: rgba(255, 255, 255, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Manrope', 'Segoe UI', sans-serif;
      background:
        radial-gradient(circle at 22% 18%, rgba(255, 122, 122, 0.55), transparent 40%),
        radial-gradient(circle at 78% 12%, rgba(230, 64, 78, 0.34), transparent 38%),
        radial-gradient(circle at 18% 58%, rgba(76, 200, 140, 0.22), transparent 42%),
        linear-gradient(130deg, rgba(255, 110, 110, 0.22), rgba(255, 160, 140, 0.08) 38%, transparent 64%),
        linear-gradient(125deg, rgba(58, 190, 130, 0.18), transparent 60%),
        radial-gradient(circle at 50% 118%, rgba(194, 32, 40, 0.18), transparent 60%),
        linear-gradient(180deg, #0f3324 0%, #1f6a45 36%, #135b39 70%, #072015 100%),
        linear-gradient(135deg, rgba(235, 60, 60, 0.9), transparent 55%);
      color: #fdfdfd;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 10% 10%, rgba(244, 211, 94, 0.28), transparent 30%),
                  radial-gradient(circle at 80% 20%, rgba(255, 90, 90, 0.28), transparent 32%),
                  radial-gradient(circle at 32% 72%, rgba(110, 192, 255, 0.2), transparent 28%),
                  radial-gradient(circle at 70% 78%, rgba(255, 80, 80, 0.12), transparent 32%),
                  radial-gradient(circle at 16% 82%, rgba(64, 190, 128, 0.18), transparent 34%);
      filter: blur(40px);
      pointer-events: none;
      z-index: 0;
    }
    #snow-canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 3;
    }
    .scene {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    .illustration {
      position: relative;
      width: min(451px, 70vw);
      aspect-ratio: 451 / 498;
      background: url('jolly alarm background.png') center / contain no-repeat;
      user-select: none;
    }
    .art-hand {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: auto;
      cursor: grab;
      touch-action: none;
      will-change: transform;
    }
    .art-hand.dragging { cursor: grabbing; }
    .counter {
      position: fixed;
      right: 10%;
      bottom: 60px;
      padding: 22px 32px;
      background: linear-gradient(135deg, rgba(194,32,40,0.95), rgba(32,140,92,0.92));
      border: 3px solid rgba(255,255,255,0.75);
      border-radius: 20px;
      color: #fefefe;
      font-family: 'Mountains of Christmas', cursive;
      font-size: 30px;
      font-weight: 700;
      letter-spacing: 1.2px;
      z-index: 4;
      backdrop-filter: blur(6px);
      box-shadow: 0 18px 40px rgba(0,0,0,0.5), 0 0 26px rgba(255, 255, 255, 0.38);
      text-shadow: 0 3px 10px rgba(0,0,0,0.32);
    }
    .title-banner {
      position: fixed;
      top: 18px;
      left: 50%;
      transform: translateX(-50%);
      padding: 22px 48px;
      border-radius: 26px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.22), transparent 50%),
                  linear-gradient(135deg, rgba(255, 94, 94, 0.35), rgba(255, 255, 255, 0.02));
      border: none;
      color: #fefefe;
      font-family: 'Mountains of Christmas', cursive;
      font-size: 72px;
      letter-spacing: 4px;
      font-weight: 700;
      text-shadow: 0 4px 14px rgba(0,0,0,0.4), 0 0 12px rgba(255, 255, 255, 0.6);
      box-shadow: 0 22px 48px rgba(0,0,0,0.38), 0 0 32px rgba(255,255,255,0.32);
      z-index: 4;
      overflow: hidden;
    }
    .title-banner::after {
      content: '';
      position: absolute;
      top: 0;
      left: -30%;
      width: 60%;
      height: 100%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.75), transparent);
      transform: skewX(-20deg);
      animation: sweep 3.5s linear infinite;
    }
    @keyframes sweep {
      0% { transform: translateX(-120%) skewX(-20deg); }
      100% { transform: translateX(220%) skewX(-20deg); }
    }
    .alarm-burst {
      position: absolute;
      width: 110px;
      height: 110px;
      transform: translate(-50%, -50%) scale(0.4);
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, rgba(255, 130, 130, 1) 30%, rgba(255, 0, 0, 0.7) 62%, transparent 75%);
      box-shadow: 0 0 36px rgba(255, 80, 80, 0.9), 0 0 110px rgba(255, 0, 0, 0.7);
      opacity: 0;
      pointer-events: none;
      z-index: 3;
      animation: alarmFlash 0.9s ease-out forwards;
      overflow: visible;
    }
    .alarm-burst::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 50%;
      width: 280px;
      height: 30px;
      transform: translate(-50%, -50%) rotate(0deg);
      border-radius: 22px;
      background: radial-gradient(ellipse at center, rgba(255,255,255,0.95) 0%, rgba(255,200,200,0.55) 45%, rgba(255,0,0,0) 70%);
      filter: blur(1px);
      opacity: 0;
      animation: glareFlash 0.9s ease-out forwards;
    }
    @keyframes alarmFlash {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.4); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 40px rgba(255, 80, 80, 0.85), 0 0 90px rgba(255, 0, 0, 0.6); }
      60% { opacity: 0.75; transform: translate(-50%, -50%) scale(1.6); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(2.4); box-shadow: 0 0 18px rgba(255, 0, 0, 0.25); }
    }
    @keyframes glareFlash {
      0% { opacity: 0; transform: translate(-50%, -50%) scaleX(0.6); }
      20% { opacity: 1; transform: translate(-50%, -50%) scaleX(1.2); }
      60% { opacity: 0.8; transform: translate(-50%, -50%) scaleX(1.8); }
      100% { opacity: 0; transform: translate(-50%, -50%) scaleX(2.6); }
    }
    .settings-panel {
      position: fixed;
      top: 86px;
      left: 16px;
      width: 230px;
      padding: 14px 16px 16px;
      background: rgba(9, 24, 19, 0.78);
      border: 1px solid rgba(255,255,255,0.35);
      border-radius: 14px;
      box-shadow: 0 14px 32px rgba(0,0,0,0.4);
      color: #eaf4ff;
      font-family: 'Manrope', 'Segoe UI', sans-serif;
      z-index: 4;
      backdrop-filter: blur(4px);
    }
    .settings-panel h3 {
      margin: 0 0 8px;
      font-family: 'Mountains of Christmas', cursive;
      font-size: 22px;
      letter-spacing: 1px;
      color: #ffd479;
      text-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }
    .settings-panel .setting {
      margin: 8px 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
      font-weight: 700;
    }
    .settings-panel label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #f7fbff;
    }
    .settings-panel input[type="range"] {
      width: 100%;
      accent-color: #ffd479;
    }
    .settings-value {
      font-weight: 800;
      color: #ffd479;
      margin-left: 8px;
    }
    .hub-button {
      width: 100%;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.4);
      background: linear-gradient(135deg, rgba(255, 90, 90, 0.95), rgba(255, 200, 120, 0.9));
      color: #0d1b14;
      font-weight: 800;
      letter-spacing: 0.8px;
      cursor: pointer;
      box-shadow: 0 12px 28px rgba(0,0,0,0.35);
      text-transform: uppercase;
    }
    .hub-button:hover { transform: translateY(-1px); }
    .hub-mini {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.1);
      color: #fefefe;
      font-weight: 800;
      letter-spacing: 0.6px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,0.3);
    }
    .hub-mini:hover { transform: translateY(-1px); }
    .snow-bomb {
      position: fixed;
      top: 0;
      left: 0;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 32px;
      background: transparent;
      box-shadow: 0 6px 14px rgba(0,0,0,0.35);
      cursor: grab;
      user-select: none;
      z-index: 5;
      transition: transform 0.1s ease;
      touch-action: none;
    }
    .snow-bomb.dragging { cursor: grabbing; }
    .corner-art {
      position: fixed;
      top: 44px;
      right: 88px;
      width: 140px;
      height: 140px;
      object-fit: contain;
      z-index: 4;
      pointer-events: none;
    }
    .corner-label {
      position: fixed;
      top: 184px;
      right: 70px;
      color: #fefefe;
      font-family: 'Mountains of Christmas', cursive;
      font-size: 20px;
      letter-spacing: 1px;
      text-shadow: 0 3px 10px rgba(0,0,0,0.35);
      z-index: 4;
      pointer-events: none;
    }
    .page {
      position: relative;
      z-index: 2;
      max-width: 1100px;
      margin: 0 auto;
      padding: 48px 24px 64px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 18px;
      margin-bottom: 36px;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--snow-soft);
      text-transform: uppercase;
      letter-spacing: 2px;
      font-weight: 700;
    }
    .brand .logo {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      background: linear-gradient(135deg, var(--cranberry), var(--cranberry-glow));
      display: grid;
      place-items: center;
      font-family: 'Mountains of Christmas', cursive;
      font-size: 26px;
      color: #fff;
      box-shadow: 0 12px 35px rgba(255, 87, 106, 0.25);
    }
    nav {
      display: flex;
      gap: 18px;
      align-items: center;
      flex-wrap: wrap;
    }
    nav a {
      color: #eaf4ff;
      text-decoration: none;
      font-weight: 600;
      padding: 10px 12px;
      border-radius: 12px;
      transition: transform 0.2s ease, background 0.2s ease;
    }
    nav a:hover { transform: translateY(-2px); background: rgba(255,255,255,0.08); }
    .cta {
      background: linear-gradient(135deg, var(--gold), #ffd479);
      color: #4a2a00;
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 10px 30px rgba(244, 211, 94, 0.35);
    }
    .hero {
      background: linear-gradient(150deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 28px;
      padding: 32px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 18px 55px rgba(0, 0, 0, 0.45);
    }
    .hero::after {
      content: '';
      position: absolute;
      inset: 12px;
      border-radius: 20px;
      border: 1px dashed rgba(255,255,255,0.06);
      pointer-events: none;
    }
    .lights {
      position: absolute;
      top: 0;
      left: -5%;
      width: 110%;
      height: 24px;
      background:
        radial-gradient(circle at 10% 50%, #ffd479 0 12px, transparent 16px),
        radial-gradient(circle at 30% 50%, #7df3ff 0 12px, transparent 16px),
        radial-gradient(circle at 50% 50%, #ff94c2 0 12px, transparent 16px),
        radial-gradient(circle at 70% 50%, #9dff7d 0 12px, transparent 16px),
        radial-gradient(circle at 90% 50%, #ffc857 0 12px, transparent 16px);
      filter: drop-shadow(0 5px 10px rgba(0,0,0,0.35));
      opacity: 0.9;
    }
    .hero-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 24px;
      align-items: center;
    }
    .eyebrow {
      font-size: 14px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--gold);
      font-weight: 800;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .eyebrow::before, .eyebrow::after {
      content: '*';
      color: var(--cranberry-glow);
      font-size: 12px;
    }
    h1 {
      font-family: 'Mountains of Christmas', cursive;
      font-size: clamp(42px, 6vw, 64px);
      margin: 12px 0;
      line-height: 1.05;
      text-shadow: 0 12px 38px rgba(0,0,0,0.35);
    }
    .hero p {
      margin: 0 0 16px;
      color: #dfefff;
      font-size: 17px;
      line-height: 1.5;
    }
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }
    .btn {
      border: none;
      cursor: pointer;
      font-weight: 800;
      border-radius: 14px;
      padding: 12px 18px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #ff5f6d, #ff8e53);
      color: #fff;
      box-shadow: 0 12px 30px rgba(255, 118, 97, 0.35);
    }
    .btn-ghost {
      background: rgba(255,255,255,0.1);
      color: #fdfdfd;
      border: 1px solid rgba(255,255,255,0.15);
    }
    .btn:hover { transform: translateY(-2px); }
    .side-card {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.08);
      backdrop-filter: blur(5px);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.35);
    }
    .side-card h3 {
      margin: 0 0 10px;
      font-family: 'Mountains of Christmas', cursive;
      font-size: 24px;
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 0;
    }
    .tag {
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.08);
      color: #f7fbff;
      font-weight: 700;
      letter-spacing: 0.4px;
    }
    .section {
      margin-top: 28px;
      background: var(--card-bg);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 16px 40px rgba(0,0,0,0.3);
    }
    .section h2 {
      margin: 0 0 10px;
      font-family: 'Mountains of Christmas', cursive;
      font-size: 28px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .card {
      padding: 16px;
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      min-height: 140px;
      position: relative;
      overflow: hidden;
    }
    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.15), transparent 35%);
      opacity: 0.8;
      pointer-events: none;
    }
    .card h3 { margin: 0 0 8px; font-size: 18px; }
    .card p { margin: 0; color: #e3f0ff; line-height: 1.4; }
    .ornaments {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .ornament {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,0.1));
      border: 2px solid rgba(255,255,255,0.25);
      position: relative;
      box-shadow: 0 12px 20px rgba(0,0,0,0.3);
    }
    .ornament::before {
      content: '';
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 12px;
      height: 6px;
      border-radius: 4px 4px 0 0;
      background: rgba(0,0,0,0.35);
    }
    .vibes {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    .vibe {
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.09);
      border: 1px solid rgba(255,255,255,0.12);
      color: #f7fbff;
      font-weight: 700;
    }
    footer {
      text-align: center;
      margin-top: 28px;
      color: #cde4ff;
      font-size: 14px;
      opacity: 0.9;
    }
    @media (max-width: 820px) {
      .hero-grid { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; }
    }
  </style>
</head>
<body>
  <canvas id="snow-canvas"></canvas>
  <div class="settings-panel">
    <h3>The Holiday Hub</h3>
    <div class="setting">
      <label>Snow speed <span class="settings-value" id="speedValue">1.0x</span></label>
      <input type="range" id="speedControl" min="0.6" max="8" step="0.1" value="2.0">
    </div>
    <div class="setting">
      <label>Snow density <span class="settings-value" id="densityValue">1.0x</span></label>
      <input type="range" id="densityControl" min="0.5" max="8.0" step="0.1" value="2.0">
    </div>
    <div class="setting">
      <label>Wind <span class="settings-value" id="windValue">0</span></label>
      <input type="range" id="windControl" min="-2000" max="2000" step="50" value="0">
    </div>
    <div class="setting">
      <label>Music volume <span class="settings-value" id="volumeValue">50%</span></label>
      <input type="range" id="volumeControl" min="0" max="100" step="1" value="50">
      <button class="hub-mini" id="muteBtn">Mute / Unmute</button>
    </div>
    <button class="hub-button" id="blizzardBtn">Blizzard Mode</button>
  </div>
  <div class="title-banner">The Festive Site</div>
  <img src="fnnuohi0u7h71.png" alt="Festive corner art" class="corner-art">
  <div class="corner-label">Snow Bomb!</div>
  <div class="snow-bomb" id="snowBomb">&#128163;</div>
  <div class="scene">
    <div class="illustration">
      <img src="jolliest hand v2.png" alt="Festive hand illustration" class="art-hand" loading="lazy" draggable="false">
    </div>
  </div>
  <div class="counter" id="jolly-counter">The Jolliness Counter: 0</div>
  <audio id="bg-audio" src="Burl Ives - A Holly Jolly Christmas.mp3" loop></audio>

  <script>
    // Festive snowfall with accumulation that builds a drift over time.
    const canvas = document.getElementById('snow-canvas');
    const ctx = canvas.getContext('2d');
    let width = 0, height = 0;
    let flakes = [];
    let ground = [];
    let segments = 180;
    let lastTime = performance.now();
    const maxPileRatio = 0.42; // limits pile height relative to viewport
    let speedMultiplier = 1;
    let densityMultiplier = 1;
    let baseFlakeCount = 0;
    let windOffset = 0;
    const blastEffects = [];

    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
      segments = Math.max(120, Math.floor(width / 7));
      const existing = ground;
      ground = new Array(segments).fill(0);
      // carry over a hint of previous snow when resizing
      for (let i = 0; i < ground.length; i++) {
        const prev = existing[Math.floor(i / ground.length * existing.length)] || 0;
        ground[i] = prev;
      }
      baseFlakeCount = Math.max(140, Math.floor(width * height / 9000));
      applyDensity();
    }

    function makeFlake() {
      const r = Math.random() * 2.4 + 1.2;
      return {
        x: Math.random() * width,
        y: Math.random() * height,
        r,
        vy: 35 + Math.random() * 40,
        drift: (Math.random() - 0.5) * 0.6,
        swingSeed: Math.random() * Math.PI * 2,
      };
    }

    function groundIndex(x) {
      return Math.min(segments - 1, Math.max(0, Math.floor(x / width * segments)));
    }

    function addSnowAt(x, amount) {
      const idx = groundIndex(x);
      const spread = 3; // spread to neighbors for softer pile
      for (let i = -spread; i <= spread; i++) {
        const target = idx + i;
        if (target < 0 || target >= ground.length) continue;
        const falloff = Math.pow(1 - Math.abs(i) / (spread + 0.5), 1.5);
        ground[target] = Math.min(height * maxPileRatio, ground[target] + amount * falloff);
      }
      softenSlope(idx, spread + 2);
    }

    function groundHeightAt(x) {
      const idx = groundIndex(x);
      return ground[idx] || 0;
    }

    // Gently flatten steep local peaks so drifts stay smooth.
    function softenSlope(center, radius) {
      const start = Math.max(1, center - radius);
      const end = Math.min(ground.length - 2, center + radius);
      const copy = ground.slice(start - 1, end + 2);
      for (let i = start; i <= end; i++) {
        const local = copy[i - start + 1];
        const left = copy[i - start];
        const right = copy[i - start + 2];
        const avg = (left + local + right) / 3;
        ground[i] = ground[i] * 0.6 + avg * 0.4;
      }
    }

    function drawGround() {
      ctx.save();
      const gradient = ctx.createLinearGradient(0, height, 0, height - height * maxPileRatio);
      gradient.addColorStop(0, 'rgba(255,255,255,0.95)');
      gradient.addColorStop(0.6, 'rgba(240,248,255,0.9)');
      gradient.addColorStop(1, 'rgba(214,235,255,0.85)');
      ctx.fillStyle = gradient;
      ctx.beginPath();
      ctx.moveTo(0, height);
      const step = width / (ground.length - 1);
      for (let i = 0; i < ground.length; i++) {
        const x = i * step;
        ctx.lineTo(x, height - ground[i]);
      }
      ctx.lineTo(width, height);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    function drawBlasts(delta) {
      for (let i = blastEffects.length - 1; i >= 0; i--) {
        const blast = blastEffects[i];
        blast.t += delta;
        const life = blast.t / blast.duration;
        if (life >= 1) {
          blastEffects.splice(i, 1);
          continue;
        }
        const alpha = (1 - life) * blast.intensity;
        const r = blast.radius * (1 + life * 0.6);
        const grad = ctx.createRadialGradient(blast.x, blast.y, 0, blast.x, blast.y, r);
        grad.addColorStop(0, `rgba(255,255,255,${0.4 * alpha})`);
        grad.addColorStop(0.4, `rgba(255,200,200,${0.3 * alpha})`);
        grad.addColorStop(1, 'rgba(255,0,0,0)');
        ctx.save();
        ctx.globalCompositeOperation = 'lighter';
        ctx.fillStyle = grad;
        ctx.beginPath();
        ctx.arc(blast.x, blast.y, r, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
      }
    }

    function clearSnowAt(x, radius) {
      let removed = 0;
      const step = width / (ground.length - 1);
      for (let i = 0; i < ground.length; i++) {
        const gx = i * step;
        const dx = Math.abs(gx - x);
        const effective = radius * 1.4;
        if (dx > effective) continue;
        const falloff = Math.cos((dx / effective) * Math.PI / 2);
        const amount = effective * 0.9 * falloff;
        const before = ground[i];
        ground[i] = Math.max(0, ground[i] - amount);
        removed += before - ground[i];
      }
      return removed;
    }

    function drawSnow(flake) {
      ctx.beginPath();
      ctx.arc(flake.x, flake.y, flake.r, 0, Math.PI * 2);
      ctx.fillStyle = 'rgba(255,255,255,0.92)';
      ctx.fill();
    }

    function applyDensity() {
      const desired = Math.max(50, Math.round(baseFlakeCount * densityMultiplier));
      if (desired > flakes.length) {
        const addCount = desired - flakes.length;
        for (let i = 0; i < addCount; i++) flakes.push(makeFlake());
      } else if (desired < flakes.length) {
        flakes.length = desired;
      }
    }

    function animate(now) {
      const delta = Math.min(0.05, (now - lastTime) / 1000); // clamp delta for stability
      lastTime = now;
      ctx.clearRect(0, 0, width, height);
      drawGround();
      drawBlasts(delta);

      const breeze = Math.sin(now * 0.0003) * 12 + windOffset;
      for (const flake of flakes) {
        flake.x += (flake.drift * 35 + breeze * 0.4 + Math.sin(now * 0.001 + flake.swingSeed) * 8) * delta;
        flake.y += flake.vy * delta * speedMultiplier;

        if (flake.x < -5) flake.x = width + 5;
        if (flake.x > width + 5) flake.x = -5;

        const groundHeight = groundHeightAt(flake.x);
        const landingY = height - groundHeight - flake.r;
        if (flake.y >= landingY) {
          addSnowAt(flake.x, flake.r * 1.1);
          flake.x = Math.random() * width;
          flake.y = -flake.r - Math.random() * 40;
        } else {
          drawSnow(flake);
        }
      }

      requestAnimationFrame(animate);
    }

    window.addEventListener('resize', resize);
    resize();
    requestAnimationFrame(animate);

    // Drag-and-spring behavior for the hand illustration.
    const hand = document.querySelector('.art-hand');
    let dragStartY = 0;
    let baseOffsetY = 0;
    let currentY = 0;
    let dragging = false;
    const maxPull = 120; // fixed short pull distance
    let jollyCount = 0;
    const counterEl = document.getElementById('jolly-counter');
    const illustrationEl = document.querySelector('.illustration');
    const alarmAnchor = { x: 108, y: 90 }; // anchor on the background art (native 451x498)
    const alarmBaseSize = { w: 451, h: 498 };
    const speedControl = document.getElementById('speedControl');
    const densityControl = document.getElementById('densityControl');
    const speedValue = document.getElementById('speedValue');
    const densityValue = document.getElementById('densityValue');
    const windControl = document.getElementById('windControl');
    const windValue = document.getElementById('windValue');
    const blizzardBtn = document.getElementById('blizzardBtn');
    const bombEl = document.getElementById('snowBomb');
    const audioEl = document.getElementById('bg-audio');
    const volumeControl = document.getElementById('volumeControl');
    const volumeValue = document.getElementById('volumeValue');
    const muteBtn = document.getElementById('muteBtn');
    const hohoEl = new Audio('ho-ho-ho-merry-christmas-439603.mp3');
    let bombPos = { x: window.innerWidth - 200, y: 40 };
    let bombDragging = false;
    let bombOffset = { x: 0, y: 0 };
    const bombSize = 64;
    let springFrame = null;

    function updateCounter() {
      if (counterEl) counterEl.textContent = `The Jolliness Counter: ${jollyCount}`;
    }

    function setHandY(y) {
      currentY = Math.min(maxPull, Math.max(0, y));
      hand.style.transform = `translateY(${currentY}px)`;
    }

    function animateBack() {
      let y = currentY;
      let velocity = 0;
      const stiffness = 0.18;
      const damping = 0.86;
      function step() {
        const force = -stiffness * y;
        velocity = velocity * damping + force;
        y += velocity;
        if (Math.abs(y) < 0.5 && Math.abs(velocity) < 0.5) {
          setHandY(0);
          springFrame = null;
          return;
        }
        setHandY(y);
        springFrame = requestAnimationFrame(step);
      }
      springFrame = requestAnimationFrame(step);
    }

    function onPointerDown(e) {
      if (springFrame) {
        cancelAnimationFrame(springFrame);
        springFrame = null;
      }
      dragging = true;
      hand.classList.add('dragging');
      dragStartY = e.clientY;
      baseOffsetY = currentY;
      hand.setPointerCapture(e.pointerId);
    }

    function onPointerMove(e) {
      if (!dragging) return;
      const deltaY = e.clientY - dragStartY;
      const nextY = baseOffsetY + deltaY;
      setHandY(nextY);
    }

    function onPointerUp(e) {
      if (!dragging) return;
      dragging = false;
      hand.classList.remove('dragging');
      hand.releasePointerCapture(e.pointerId);
      if (currentY >= maxPull - 1) {
        jollyCount += 1;
        updateCounter();
        if (hohoEl && jollyCount % 10 === 0) {
          hohoEl.currentTime = 0;
          hohoEl.volume = audioEl ? Math.min(0.3, audioEl.volume * 0.6) : 0.3;
          hohoEl.play().catch(() => {});
        }
        triggerAlarm();
      }
      animateBack();
    }

    if (hand) {
      hand.addEventListener('dragstart', e => e.preventDefault());
      hand.addEventListener('pointerdown', onPointerDown);
      hand.addEventListener('pointermove', onPointerMove);
      hand.addEventListener('pointerup', onPointerUp);
      hand.addEventListener('pointercancel', onPointerUp);
      updateCounter();
    }

    function triggerAlarm() {
      const burst = document.createElement('div');
      burst.className = 'alarm-burst';
      if (illustrationEl) {
        const scaleX = illustrationEl.clientWidth / alarmBaseSize.w;
        const scaleY = illustrationEl.clientHeight / alarmBaseSize.h;
        const leftPx = alarmAnchor.x * scaleX;
        const topPx = alarmAnchor.y * scaleY;
        burst.style.left = `${leftPx}px`;
        burst.style.top = `${topPx}px`;
        illustrationEl.appendChild(burst);
      } else {
        document.body.appendChild(burst);
      }
      burst.addEventListener('animationend', () => burst.remove());
    }

    function addBlastEffect(x, removed) {
      const intensity = Math.max(0.5, Math.min(1.4, removed / 5000));
      const radius = Math.max(260, 240 + Math.min(420, removed / 16));
      const y = height - groundHeightAt(x);
      blastEffects.push({ x, y, radius, intensity, t: 0, duration: 1.2 });
    }

    function launchBomb() {
      let x = bombPos.x;
      let y = bombPos.y;
      const gravity = 980;
      let vx = 0;
      let vy = 0;
      let last = performance.now();
      function step(now) {
        const dt = Math.min(0.05, (now - last) / 1000);
        last = now;
        x += vx * dt;
        y += vy * dt + 0.5 * gravity * dt * dt;
        vy += gravity * dt;
        bombPos = { x, y };
        bombEl.style.transform = `translate(${x}px, ${y}px)`;
        const groundY = height - groundHeightAt(x);
        if (y + bombSize >= groundY) {
          const removed = clearSnowAt(x, 140);
          addBlastEffect(x, removed);
          resetBomb();
          return;
        }
        if (y > height + 200 || x < -200 || x > width + 200) {
          resetBomb();
          return;
        }
        requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function resetBomb() {
      bombPos = { x: window.innerWidth - 200, y: 40 };
      bombEl.style.transform = `translate(${bombPos.x}px, ${bombPos.y}px)`;
    }

    function bindBomb() {
      if (!bombEl) return;
      bombEl.style.transform = `translate(${bombPos.x}px, ${bombPos.y}px)`;
      bombEl.addEventListener('dragstart', e => e.preventDefault());
      bombEl.addEventListener('pointerdown', e => {
        bombDragging = true;
        bombOffset = { x: e.clientX - bombPos.x, y: e.clientY - bombPos.y };
        bombEl.classList.add('dragging');
        bombEl.setPointerCapture(e.pointerId);
      });
      bombEl.addEventListener('pointermove', e => {
        if (!bombDragging) return;
        bombPos.x = e.clientX - bombOffset.x;
        bombPos.y = e.clientY - bombOffset.y;
        bombPos.x = Math.max(0, Math.min(width - bombSize, bombPos.x));
        bombPos.y = Math.max(0, Math.min(height - bombSize, bombPos.y));
        bombEl.style.transform = `translate(${bombPos.x}px, ${bombPos.y}px)`;
      });
      bombEl.addEventListener('pointerup', e => {
        if (!bombDragging) return;
        bombDragging = false;
        bombEl.classList.remove('dragging');
        bombEl.releasePointerCapture(e.pointerId);
        launchBomb();
      });
      bombEl.addEventListener('pointercancel', () => {
        bombDragging = false;
        bombEl.classList.remove('dragging');
      });
    }

    // Holiday Hub controls
    function bindSettings() {
      if (speedControl && speedValue) {
        const updateSpeed = () => {
          speedMultiplier = parseFloat(speedControl.value);
          speedValue.textContent = `${speedMultiplier.toFixed(1)}x`;
        };
        speedControl.addEventListener('input', updateSpeed);
        updateSpeed();
      }
      if (densityControl && densityValue) {
        const updateDensity = () => {
          densityMultiplier = parseFloat(densityControl.value);
          densityValue.textContent = `${densityMultiplier.toFixed(1)}x`;
          applyDensity();
        };
        densityControl.addEventListener('input', updateDensity);
        updateDensity();
      }
      if (windControl && windValue) {
        const updateWind = () => {
          windOffset = parseFloat(windControl.value) || 0;
          windValue.textContent = `${windOffset.toFixed(0)}`;
        };
        windControl.addEventListener('input', updateWind);
        updateWind();
      }
      if (audioEl && volumeControl && volumeValue && muteBtn) {
        const updateVolume = () => {
          const vol = Math.max(0, Math.min(1, parseInt(volumeControl.value, 10) / 100));
          audioEl.volume = vol;
          volumeValue.textContent = `${Math.round(vol * 100)}%`;
          try { audioEl.play().catch(() => {}); } catch {}
        };
        volumeControl.addEventListener('input', updateVolume);
        muteBtn.addEventListener('click', () => {
          if (audioEl.muted || audioEl.volume === 0) {
            audioEl.muted = false;
            if (parseInt(volumeControl.value, 10) === 0) volumeControl.value = 50;
          } else {
            audioEl.muted = true;
          }
          if (audioEl.muted) {
            audioEl.volume = 0;
            volumeValue.textContent = '0%';
          } else {
            const vol = parseInt(volumeControl.value, 10) / 100;
            audioEl.volume = vol;
            volumeValue.textContent = `${Math.round(vol * 100)}%`;
            try { audioEl.play().catch(() => {}); } catch {}
          }
        });
        const kickAudio = () => {
          if (!audioEl) return;
          audioEl.volume = parseInt(volumeControl.value, 10) / 100;
          audioEl.muted = false;
          audioEl.play().catch(() => {});
          window.removeEventListener('pointerdown', kickAudio);
          window.removeEventListener('keydown', kickAudio);
        };
        window.addEventListener('pointerdown', kickAudio, { once: true });
        window.addEventListener('keydown', kickAudio, { once: true });
        updateVolume();
      }
      if (blizzardBtn) {
        blizzardBtn.addEventListener('click', () => {
          const blizzardSpeed = 8;
          const blizzardDensity = 8;
          const blizzardWind = 2000;
          speedMultiplier = blizzardSpeed;
          densityMultiplier = blizzardDensity;
          windOffset = blizzardWind;
          if (speedControl) speedControl.value = blizzardSpeed;
          if (densityControl) densityControl.value = blizzardDensity;
          if (windControl) windControl.value = blizzardWind;
          if (speedValue) speedValue.textContent = `${blizzardSpeed.toFixed(1)}x`;
          if (densityValue) densityValue.textContent = `${blizzardDensity.toFixed(1)}x`;
          if (windValue) windValue.textContent = `${blizzardWind.toFixed(0)}`;
          applyDensity();
        });
      }
    }

    bindSettings();
    bindBomb();
    window.addEventListener('resize', () => {
      if (!bombDragging) resetBomb();
    });
  </script>
</body>
</html>
